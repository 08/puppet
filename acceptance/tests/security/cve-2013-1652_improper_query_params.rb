# It is possible to retrieve catalogs for other agents - bypassing any
# access control and posioning the master's cached data by exploiting
# yaml parsing in the indirector (ish)
require 'json'

test_name "CVE 2013-1652 Improper query parameter validation" do

  with_master_running_on( master, '--autosign true' ) do
    # Ensure each agent has a signed cert
    on agents, puppet_agent( '-t' )

    agents.each do |agent|
      next if agent['roles'].include?( 'master' )

      certname = on(agent, puppet_agent("--configprint certname")).stdout.chomp

      payload = "https://#{master}:8140/production/catalog/#{certname}?use_node=" +
                "---%20!ruby/object:Puppet::Node%0A%20%20" +
                "name:%20#{master}%0A%20%20classes:%20\[\]%0A%20%20" +
                "parameters:%20%7B%7D%0A%20%20facts:%20%7B%7D"

      cert_path = on(agent, puppet_agent("--configprint hostcert")).stdout.chomp
      key_path = on(agent, puppet_agent("--configprint hostprivkey")).stdout.chomp
      curl_base = "curl -g --cert #{cert_path} --key #{key_path} -k -H 'Accept: pson'"

      curl_call =  "#{curl_base} '#{payload}'"

      step "Attempt to retrieve another nodes catalog" do
        on agent, curl_call do |test|
          begin
            res = JSON.parse( test.stdout )
            fail_test( "Retrieved catalog for #{master} from #{agent}" ) if
              res['data']['name'] == master.name
          rescue JSON::ParserError
            # good, continue
          end
        end
      end

      step "Attempt to poison the master's node cache" do
        yamldir = on( master, puppet_master( '--configprint yamldir' )).stdout.chomp
        exploited = "#{yamldir}/node/you.lose.yaml"
        on master, "rm -rf #{exploited}"
        payload2 = "https://#{master}:8140/production/node/#{certname}?instance=" +
                   "---+%21ruby%2Fobject%3APuppet%3A%3ANode%0A+classes" +
                   "%3A%0A+-+foo%0A+name%3A+you.lose%0A+parameters" +
                   "%3A+%7B%7D%0A+time%3A+2013-02-28+15%3A12%3A30.367008+-08%3A00"

        on agent, "#{curl_base} '#{payload2}'"

        on master, "[ ! -f #{exploited} ]"
      end
    end
  end
end
