test_name "CVE 2013-1654 SSL2 Downgrade of Master connection" do

  def suitable?(host)
    suitable = false
    on host,
       %Q{#{host['puppetbindir']}/ruby -e "require 'openssl'; } +
       %q{puts OpenSSL::SSL::SSLContext::METHODS" | grep '^SSLv2$'},
       :acceptable_exit_codes => [0,1] do |test|

      suitable = test.stdout =~ /SSLv2/
    end
    suitable
  end

  if suitable?( master )
    with_master_running_on( master, '--autosign true' ) do

      agent = agents.first
      on agent, puppet_agent( '-t' )

      certfile = on(agent, puppet_agent("--configprint hostcert")).stdout.chomp
      keyfile = on(agent, puppet_agent("--configprint hostprivkey")).stdout.chomp
      cafile = on(agent, puppet_agent("--configprint localcacert")).stdout.chomp

      openssl_call = "openssl s_client -connect #{master}:8140 " +
                     "-cert \"#{certfile}\" -key \"#{keyfile}\" -CAfile \"#{cafile}\" -ssl2 < /dev/null"

      on agent, openssl_call do |test|
        assert_no_match /SERVER-HELLO/, test.stdout
      end
    end
  else
    logger.debug( "Not testing master as SSLv2 isn't available to it" )
  end
end
