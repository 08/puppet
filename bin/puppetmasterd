#!/usr/bin/ruby -w

#--------------------
# the central puppet server
#
# $Id$

require 'getoptlong'
require 'puppet'
require 'puppet/server'

result = GetoptLong.new(
	[ "--logfile",	"-l",			GetoptLong::REQUIRED_ARGUMENT ],
	[ "--manifest",	"-m",			GetoptLong::REQUIRED_ARGUMENT ],
	[ "--ssldir",	"-s",			GetoptLong::REQUIRED_ARGUMENT ],
	[ "--port",	    "-p",			GetoptLong::REQUIRED_ARGUMENT ],
	[ "--noinit",   "-n",			GetoptLong::NO_ARGUMENT ],
	[ "--autosign", "-a",			GetoptLong::NO_ARGUMENT ],
	[ "--debug",	"-d",			GetoptLong::NO_ARGUMENT ],
	[ "--verbose",	"-v",			GetoptLong::NO_ARGUMENT ],
	[ "--noca",         			GetoptLong::NO_ARGUMENT ],
	[ "--help",		"-h",			GetoptLong::NO_ARGUMENT ]
)

noinit = false

haveca = true
master = {}
ca = {}
args = {}

result.each { |opt,arg|
	case opt
		when "--help"
			puts "There is no help yet"
			exit
		when "--verbose"
            Puppet[:loglevel] = :info
		when "--debug"
            Puppet[:debug] = true
		when "--autosign"
            ca[:autosign] = true
		when "--noca"
            haveca = false
		when "--port"
            args[:Port] = arg
		when "--ssldir"
            Puppet[:ssldir] = arg
		when "--manifest"
            master[:File] = arg
		when "--noinit"
            noinit = true
		when "--logfile"
            args[:AccessLog] = arg
		else
			$stderr.puts "Invalid option '#{opt}'"
            exit(1)
	end
}

bg = false

Puppet[:autosign] = true

unless Puppet[:loglevel] == :debug or Puppet[:loglevel] == :info
    bg = true
end

if bg
    Puppet[:logdest] = Puppet[:masterlog]
end

handlers = {
    :Master => master,
    :Status => {}
}


if haveca
    handlers[:CA] = ca
end

if File.exists?(Puppet[:fileserverconfig])
    handlers[:FileServer] = {
        :Config => Puppet[:fileserverconfig]
    }
end

args[:Handlers] = handlers

begin
    # use the default, um, everything
    #server = Puppet::Server.new(:CA => ca)
    server = Puppet::Server.new(args)
rescue => detail
    $stderr.puts detail
    exit(1)
end

if bg
    server.daemonize
end

trap(:INT) {
    server.shutdown
}
begin
    server.start
rescue => detail
    Puppet.err "Could not start puppetmaster: %s" % detail
    exit(1)
end
